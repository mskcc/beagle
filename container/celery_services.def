Bootstrap: docker
From: ubuntu:19.10
Includecmd: no

%environment
    export BEAGLE_PATH=/usr/bin/beagle

%startscript
    celery -A ${BEAGLE_PATH}/beagle_etl beat -l info -f ${SINGULARITY_APPDATA}/logs/beagle_beat.log
    celery -A ${BEAGLE_PATH}/beagle_etl worker -l info -f ${SINGULARITY_APPDATA}/logs/beagle_worker.log
    celery -A ${BEAGLE_PATH}/beagle_etl worker --concurrency 1 -l info -Q beagle_job_scheduler -f ${SINGULARITY_APPDATA}/logs/beagle_scheduler.log
    celery -A ${BEAGLE_PATH}/beagle_etl worker -l info -Q runner_queue -f ${SINGULARITY_APPDATA}/logs/beagle_runner.log

%post
    export DEBIAN_FRONTEND=noninteractive \
    && apt-get clean && apt-get update -qq \
    && apt-get -y install \
        python python-pip python-dev python3 python3-pip wget \
        libldap2-dev libsasl2-dev libssl-dev \
        postgresql postgresql-contrib libpq-dev \
        gawk build-essential \
        git

    cd /usr/bin \
    && git clone https://github.com/mskcc/beagle
    cd /usr/bin/beagle \
    && python3 -m pip install python-ldap \
    && pip3 install -r requirements.txt
